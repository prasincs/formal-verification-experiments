name: Build RPi4 Graphics SD Card Image

on:
  push:
    branches: [main, 'claude/**']
    paths:
      - 'sel4-microkernel/rpi4-graphics/**'
      - '.github/workflows/rpi4-graphics.yml'
  pull_request:
    paths:
      - 'sel4-microkernel/rpi4-graphics/**'
  workflow_dispatch:
    inputs:
      rpi4_memory:
        description: 'Raspberry Pi 4 memory variant'
        required: true
        default: '4gb'
        type: choice
        options:
          - 1gb
          - 2gb
          - 4gb
          - 8gb
      create_release:
        description: 'Create a GitHub release'
        required: false
        default: false
        type: boolean

env:
  MICROKIT_VERSION: "1.4.1"
  RPI4_MEMORY: ${{ github.event.inputs.rpi4_memory || '4gb' }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            qemu-system-arm \
            dosfstools \
            mtools \
            curl

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: Cache Microkit SDK
        id: cache-microkit
        uses: actions/cache@v4
        with:
          path: sel4-microkernel/rpi4-graphics/microkit-sdk
          key: microkit-sdk-${{ env.MICROKIT_VERSION }}-linux-x86-64

      - name: Download Microkit SDK
        if: steps.cache-microkit.outputs.cache-hit != 'true'
        working-directory: sel4-microkernel/rpi4-graphics
        run: |
          curl -L -o microkit-sdk.tar.gz \
            "https://github.com/seL4/microkit/releases/download/${{ env.MICROKIT_VERSION }}/microkit-sdk-${{ env.MICROKIT_VERSION }}-linux-x86-64.tar.gz"
          mkdir -p microkit-sdk
          tar -xzf microkit-sdk.tar.gz -C microkit-sdk --strip-components=1
          rm microkit-sdk.tar.gz

      - name: Cache Raspberry Pi firmware
        id: cache-firmware
        uses: actions/cache@v4
        with:
          path: sel4-microkernel/rpi4-graphics/build/firmware
          key: rpi-firmware-v1

      - name: Download Raspberry Pi firmware
        if: steps.cache-firmware.outputs.cache-hit != 'true'
        working-directory: sel4-microkernel/rpi4-graphics
        run: make firmware

      - name: Build system image
        working-directory: sel4-microkernel/rpi4-graphics
        run: |
          export MICROKIT_SDK=$PWD/microkit-sdk
          make RPI4_MEMORY=${{ env.RPI4_MEMORY }}

      - name: Create boot files
        working-directory: sel4-microkernel/rpi4-graphics
        run: |
          export MICROKIT_SDK=$PWD/microkit-sdk
          make RPI4_MEMORY=${{ env.RPI4_MEMORY }} bootfiles

      - name: Create SD card image
        working-directory: sel4-microkernel/rpi4-graphics
        run: |
          # Create 64MB FAT32 image
          dd if=/dev/zero of=build/rpi4-sel4-graphics-${{ env.RPI4_MEMORY }}.img bs=1M count=64

          # Create FAT32 filesystem
          mkfs.vfat -F 32 -n SEL4BOOT build/rpi4-sel4-graphics-${{ env.RPI4_MEMORY }}.img

          # Copy boot files using mtools (no root required)
          mcopy -i build/rpi4-sel4-graphics-${{ env.RPI4_MEMORY }}.img build/boot/* ::

      - name: Generate checksums
        working-directory: sel4-microkernel/rpi4-graphics/build
        run: |
          sha256sum rpi4-sel4-graphics-${{ env.RPI4_MEMORY }}.img > rpi4-sel4-graphics-${{ env.RPI4_MEMORY }}.img.sha256
          sha256sum boot/loader.img > loader.img.sha256

      - name: Upload boot files artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpi4-sel4-graphics-bootfiles-${{ env.RPI4_MEMORY }}
          path: |
            sel4-microkernel/rpi4-graphics/build/boot/
          retention-days: 30

      - name: Upload SD card image artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpi4-sel4-graphics-sdcard-${{ env.RPI4_MEMORY }}
          path: |
            sel4-microkernel/rpi4-graphics/build/rpi4-sel4-graphics-${{ env.RPI4_MEMORY }}.img
            sel4-microkernel/rpi4-graphics/build/rpi4-sel4-graphics-${{ env.RPI4_MEMORY }}.img.sha256
          retention-days: 30

      - name: Upload build report
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ env.RPI4_MEMORY }}
          path: sel4-microkernel/rpi4-graphics/build/report.txt
          retention-days: 30

  # Build all memory variants for releases
  build-all-variants:
    if: github.event.inputs.create_release == 'true' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        memory: [1gb, 2gb, 4gb, 8gb]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            dosfstools \
            mtools \
            curl

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: Cache Microkit SDK
        id: cache-microkit
        uses: actions/cache@v4
        with:
          path: sel4-microkernel/rpi4-graphics/microkit-sdk
          key: microkit-sdk-${{ env.MICROKIT_VERSION }}-linux-x86-64

      - name: Download Microkit SDK
        if: steps.cache-microkit.outputs.cache-hit != 'true'
        working-directory: sel4-microkernel/rpi4-graphics
        run: |
          curl -L -o microkit-sdk.tar.gz \
            "https://github.com/seL4/microkit/releases/download/${{ env.MICROKIT_VERSION }}/microkit-sdk-${{ env.MICROKIT_VERSION }}-linux-x86-64.tar.gz"
          mkdir -p microkit-sdk
          tar -xzf microkit-sdk.tar.gz -C microkit-sdk --strip-components=1
          rm microkit-sdk.tar.gz

      - name: Cache Raspberry Pi firmware
        id: cache-firmware
        uses: actions/cache@v4
        with:
          path: sel4-microkernel/rpi4-graphics/build/firmware
          key: rpi-firmware-v1

      - name: Download Raspberry Pi firmware
        if: steps.cache-firmware.outputs.cache-hit != 'true'
        working-directory: sel4-microkernel/rpi4-graphics
        run: make firmware

      - name: Build for ${{ matrix.memory }}
        working-directory: sel4-microkernel/rpi4-graphics
        run: |
          export MICROKIT_SDK=$PWD/microkit-sdk
          make RPI4_MEMORY=${{ matrix.memory }} bootfiles

          # Create SD card image
          dd if=/dev/zero of=build/rpi4-sel4-graphics-${{ matrix.memory }}.img bs=1M count=64
          mkfs.vfat -F 32 -n SEL4BOOT build/rpi4-sel4-graphics-${{ matrix.memory }}.img
          mcopy -i build/rpi4-sel4-graphics-${{ matrix.memory }}.img build/boot/* ::

          # Checksums
          cd build
          sha256sum rpi4-sel4-graphics-${{ matrix.memory }}.img > rpi4-sel4-graphics-${{ matrix.memory }}.img.sha256

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.memory }}
          path: |
            sel4-microkernel/rpi4-graphics/build/rpi4-sel4-graphics-${{ matrix.memory }}.img
            sel4-microkernel/rpi4-graphics/build/rpi4-sel4-graphics-${{ matrix.memory }}.img.sha256

  # Create GitHub release with all variants
  release:
    if: github.event.inputs.create_release == 'true'
    needs: build-all-variants
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
          pattern: release-*
          merge-multiple: true

      - name: Create release notes
        run: |
          cat > release-notes.md << 'EOF'
          # seL4 Microkit Graphics Demo for Raspberry Pi 4

          Bootable SD card images demonstrating seL4 Microkit with framebuffer graphics.

          ## Downloads

          Choose the image matching your Raspberry Pi 4 memory:

          | Model | Image |
          |-------|-------|
          | Pi 4 (1GB) | `rpi4-sel4-graphics-1gb.img` |
          | Pi 4 (2GB) | `rpi4-sel4-graphics-2gb.img` |
          | Pi 4 (4GB) | `rpi4-sel4-graphics-4gb.img` |
          | Pi 4 (8GB) | `rpi4-sel4-graphics-8gb.img` |

          ## Flashing

          **Using Raspberry Pi Imager:**
          1. Download the `.img` file for your Pi 4 variant
          2. Open Raspberry Pi Imager
          3. Choose OS → Use custom → Select the downloaded image
          4. Choose storage → Select your SD card
          5. Write

          **Using dd (Linux/macOS):**
          ```bash
          sudo dd if=rpi4-sel4-graphics-4gb.img of=/dev/sdX bs=4M status=progress
          ```

          ## What You'll See

          After booting, the HDMI display shows an architecture diagram of the seL4 stack.

          ## Optional: TPM 2.0

          For measured boot, add a compatible TPM module:
          - GeeekPi TPM9670 (Amazon)
          - LetsTrust TPM (EU)

          ## Verification

          Verify downloads with SHA256:
          ```bash
          sha256sum -c rpi4-sel4-graphics-4gb.img.sha256
          ```
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: rpi4-graphics-${{ github.run_number }}
          name: RPi4 Graphics Demo v${{ github.run_number }}
          body_path: release-notes.md
          files: |
            release-artifacts/*.img
            release-artifacts/*.sha256
          draft: false
          prerelease: false
