name: Mock Pi Boot Test (QEMU)

on:
  push:
    branches: [main, "claude/*"]
    paths:
      - 'sel4-microkernel/**'
      - '.github/workflows/qemu-mockpi.yml'
  pull_request:
    paths:
      - 'sel4-microkernel/**'
  workflow_dispatch:
    inputs:
      enable_tpm:
        description: 'Enable TPM 2.0 emulation'
        required: false
        default: true
        type: boolean
      boot_timeout:
        description: 'Boot timeout in seconds'
        required: false
        default: '30'
        type: string

env:
  MICROKIT_VERSION: "2.1.0"
  MICROKIT_SDK_SHA256: "faff1b6d6b546cbb0bfea134588499533130d406ae2a5e533e791ddf23ac7599"

jobs:
  qemu-mockpi:
    name: Mock Pi Boot Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-arm \
            qemu-system-misc \
            swtpm \
            swtpm-tools \
            gcc-aarch64-linux-gnu

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: Cache Microkit SDK
        id: cache-microkit
        uses: actions/cache@v4
        with:
          path: /opt/microkit-sdk
          key: microkit-sdk-${{ env.MICROKIT_VERSION }}-linux-x86-64

      - name: Download Microkit SDK
        if: steps.cache-microkit.outputs.cache-hit != 'true'
        run: |
          curl -L -o /tmp/microkit-sdk.tar.gz \
            "https://github.com/seL4/microkit/releases/download/${{ env.MICROKIT_VERSION }}/microkit-sdk-${{ env.MICROKIT_VERSION }}-linux-x86-64.tar.gz"

          echo "${{ env.MICROKIT_SDK_SHA256 }}  /tmp/microkit-sdk.tar.gz" | sha256sum -c -

          sudo mkdir -p /opt/microkit-sdk
          sudo tar -xzf /tmp/microkit-sdk.tar.gz -C /opt/microkit-sdk --strip-components=1
          rm /tmp/microkit-sdk.tar.gz

      - name: Build for QEMU virt (AArch64)
        working-directory: sel4-microkernel/microkit-hello
        run: |
          export MICROKIT_SDK=/opt/microkit-sdk
          export SEL4_INCLUDE_DIRS=$MICROKIT_SDK/board/qemu_virt_aarch64/debug/include

          echo "=== Build Environment ==="
          echo "MICROKIT_SDK=$MICROKIT_SDK"
          echo "Board: qemu_virt_aarch64"
          rustc --version
          cargo --version

          echo "=== Building Microkit System ==="
          make ARCH=aarch64 MICROKIT_SDK=$MICROKIT_SDK

      - name: Setup TPM 2.0 emulator
        if: ${{ github.event.inputs.enable_tpm != 'false' }}
        run: |
          echo "=== Setting up swtpm (Software TPM 2.0) ==="
          mkdir -p /tmp/tpm-state

          # Initialize TPM state
          swtpm_setup --tpm2 \
            --tpmstate /tmp/tpm-state \
            --createek \
            --decryption \
            --create-ek-cert \
            --create-platform-cert \
            --lock-nvram \
            --overwrite \
            --display

          # Start swtpm in daemon mode
          swtpm socket \
            --tpmstate dir=/tmp/tpm-state \
            --ctrl type=unixio,path=/tmp/tpm-state/swtpm.sock \
            --tpm2 \
            --log level=20,file=/tmp/tpm-state/swtpm.log \
            -d

          # Wait for socket to be ready
          for i in {1..10}; do
            if [ -S /tmp/tpm-state/swtpm.sock ]; then
              echo "TPM socket ready"
              break
            fi
            echo "Waiting for TPM socket... ($i/10)"
            sleep 1
          done

          if [ ! -S /tmp/tpm-state/swtpm.sock ]; then
            echo "ERROR: TPM socket not created"
            cat /tmp/tpm-state/swtpm.log || true
            exit 1
          fi

      - name: Boot test (with TPM)
        if: ${{ github.event.inputs.enable_tpm != 'false' }}
        working-directory: sel4-microkernel/microkit-hello
        run: |
          TIMEOUT="${{ github.event.inputs.boot_timeout || '30' }}"
          echo "=== QEMU Mock Pi Boot Test (with TPM 2.0) ==="
          echo "Timeout: ${TIMEOUT}s"
          echo ""

          # Run QEMU with TPM and capture output
          timeout ${TIMEOUT}s qemu-system-aarch64 \
            -machine virt,virtualization=on \
            -cpu cortex-a53 \
            -m 2G \
            -nographic \
            -serial mon:stdio \
            -chardev socket,id=chrtpm,path=/tmp/tpm-state/swtpm.sock \
            -tpmdev emulator,id=tpm0,chardev=chrtpm \
            -device tpm-tis-device,tpmdev=tpm0 \
            -device loader,file=build/aarch64/loader.img,addr=0x70000000,cpu-num=0 \
            2>&1 | tee boot.log || true

          echo ""
          echo "=== Boot Log Analysis ==="

      - name: Boot test (without TPM)
        if: ${{ github.event.inputs.enable_tpm == 'false' }}
        working-directory: sel4-microkernel/microkit-hello
        run: |
          TIMEOUT="${{ github.event.inputs.boot_timeout || '30' }}"
          echo "=== QEMU Mock Pi Boot Test ==="
          echo "Timeout: ${TIMEOUT}s"
          echo ""

          # Run QEMU and capture output
          timeout ${TIMEOUT}s qemu-system-aarch64 \
            -machine virt,virtualization=on \
            -cpu cortex-a53 \
            -m 2G \
            -nographic \
            -serial mon:stdio \
            -device loader,file=build/aarch64/loader.img,addr=0x70000000,cpu-num=0 \
            2>&1 | tee boot.log || true

          echo ""
          echo "=== Boot Log Analysis ==="

      - name: Verify boot success
        working-directory: sel4-microkernel/microkit-hello
        run: |
          echo "=== Checking for expected boot markers ==="

          PASS=true

          # Check for seL4 Microkit banner
          if grep -q "seL4 Microkit" boot.log; then
            echo "✓ seL4 Microkit banner found"
          else
            echo "✗ seL4 Microkit banner NOT found"
            PASS=false
          fi

          # Check for Protection Domain initialization
          if grep -q "Protection Domain" boot.log; then
            echo "✓ Protection Domain initialized"
          else
            echo "✗ Protection Domain NOT initialized"
            PASS=false
          fi

          # Check for verified components demo
          if grep -q "verified" boot.log; then
            echo "✓ Verified components running"
          else
            echo "⚠ Verified components output not found (may be OK)"
          fi

          # Check for "System ready" message
          if grep -q "System ready" boot.log; then
            echo "✓ System ready message found"
          else
            echo "⚠ System ready message not found"
          fi

          # Check for kernel panics or crashes
          if grep -qi "panic\|fault\|exception\|error" boot.log; then
            echo "⚠ Potential errors in boot log (review manually)"
            grep -i "panic\|fault\|exception\|error" boot.log || true
          else
            echo "✓ No obvious errors in boot log"
          fi

          echo ""
          if [ "$PASS" = true ]; then
            echo "=== BOOT TEST PASSED ==="
          else
            echo "=== BOOT TEST FAILED ==="
            echo ""
            echo "Full boot log:"
            cat boot.log
            exit 1
          fi

      - name: Upload boot log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qemu-boot-log
          path: sel4-microkernel/microkit-hello/boot.log
          retention-days: 7

      - name: Upload TPM log
        if: ${{ always() && github.event.inputs.enable_tpm != 'false' }}
        uses: actions/upload-artifact@v4
        with:
          name: tpm-emulator-log
          path: /tmp/tpm-state/swtpm.log
          retention-days: 7

  # Test matrix for different configurations
  qemu-mockpi-matrix:
    name: Mock Pi (${{ matrix.arch }})
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        arch: [aarch64]
        # riscv64 can be added when microkit-hello supports it fully
        # arch: [aarch64, riscv64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-arm \
            qemu-system-misc \
            gcc-aarch64-linux-gnu \
            gcc-riscv64-linux-gnu

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      - name: Cache Microkit SDK
        id: cache-microkit
        uses: actions/cache@v4
        with:
          path: /opt/microkit-sdk
          key: microkit-sdk-${{ env.MICROKIT_VERSION }}-linux-x86-64

      - name: Download Microkit SDK
        if: steps.cache-microkit.outputs.cache-hit != 'true'
        run: |
          curl -L -o /tmp/microkit-sdk.tar.gz \
            "https://github.com/seL4/microkit/releases/download/${{ env.MICROKIT_VERSION }}/microkit-sdk-${{ env.MICROKIT_VERSION }}-linux-x86-64.tar.gz"

          echo "${{ env.MICROKIT_SDK_SHA256 }}  /tmp/microkit-sdk.tar.gz" | sha256sum -c -

          sudo mkdir -p /opt/microkit-sdk
          sudo tar -xzf /tmp/microkit-sdk.tar.gz -C /opt/microkit-sdk --strip-components=1

      - name: Build for QEMU (${{ matrix.arch }})
        working-directory: sel4-microkernel/microkit-hello
        run: |
          export MICROKIT_SDK=/opt/microkit-sdk
          make ARCH=${{ matrix.arch }} MICROKIT_SDK=$MICROKIT_SDK

      - name: Boot test (${{ matrix.arch }})
        working-directory: sel4-microkernel/microkit-hello
        run: |
          echo "=== QEMU Boot Test (${{ matrix.arch }}) ==="

          if [ "${{ matrix.arch }}" = "aarch64" ]; then
            timeout 30s qemu-system-aarch64 \
              -machine virt,virtualization=on \
              -cpu cortex-a53 \
              -m 2G \
              -nographic \
              -device loader,file=build/aarch64/loader.img,addr=0x70000000,cpu-num=0 \
              2>&1 | tee boot.log || true
          elif [ "${{ matrix.arch }}" = "riscv64" ]; then
            timeout 30s qemu-system-riscv64 \
              -machine virt \
              -m 2G \
              -nographic \
              -bios default \
              -kernel build/riscv64/loader.img \
              2>&1 | tee boot.log || true
          fi

          # Verify boot
          if grep -q "seL4 Microkit" boot.log; then
            echo "✓ Boot successful on ${{ matrix.arch }}"
          else
            echo "✗ Boot failed on ${{ matrix.arch }}"
            cat boot.log
            exit 1
          fi
