# GeeekPi TPM9670 Module (Infineon SLB 9670)

Documentation for using the GeeekPi TPM9670 TPM 2.0 module with seL4 Microkit on Raspberry Pi 4.

## Hardware Overview

- **Chip**: Infineon SLB 9670 TPM 2.0
- **Interface**: SPI
- **Vendor ID**: 0x15D1 (Infineon)

## Raspberry Pi GPIO Pinout

The TPM9670 HAT covers pins 1-26 on the 40-pin GPIO header.

### SPI Connections

| Function | GPIO | Physical Pin | BCM2711 Function |
|----------|------|--------------|------------------|
| MOSI     | 10   | 19           | SPI0_MOSI (ALT0) |
| MISO     | 9    | 21           | SPI0_MISO (ALT0) |
| SCLK     | 11   | 23           | SPI0_SCLK (ALT0) |
| CE1      | 7    | 26           | SPI0_CE1 (ALT0)  |
| 3.3V     | -    | 1            | Power            |
| GND      | -    | 6            | Ground           |

**Important**: The TPM9670 uses **CE1 (GPIO 7, Pin 26)** by default, NOT CE0.

### Serial Debug (UART5)

Since the TPM HAT covers pins 1-26, use UART5 on the extended header for serial debug:

| Function | GPIO | Physical Pin | BCM2711 Function |
|----------|------|--------------|------------------|
| TX       | 12   | 32           | UART5_TXD (ALT4) |
| RX       | 13   | 33           | UART5_RXD (ALT4) |
| GND      | -    | 34           | Ground           |

**Baud Rate**: 9600 (confirmed working with seL4)

#### Confirmed Working Cable Setup

USB-to-Serial adapter wiring:

| Pi Pin | GPIO | Pi Function | Cable Color | Adapter Connection |
|--------|------|-------------|-------------|-------------------|
| 32     | 12   | UART5_TXD   | Yellow      | RX on adapter     |
| 33     | 13   | UART5_RXD   | Orange      | TX on adapter     |
| 34     | -    | GND         | Black       | GND on adapter    |

Serial terminal settings: **9600 baud, 8N1**

## Linux Configuration (Reference)

For Linux (not seL4), add to `/boot/config.txt`:
```
dtparam=spi=on
dtoverlay=tpm-slb9670
```

## TCG TPM TIS SPI Protocol

The TPM uses the TCG (Trusted Computing Group) TPM Interface Specification over SPI.

### Address Space

All TPM registers are in the **0xD4xxxx** address space:

| Register     | Address   | Size | Description |
|-------------|-----------|------|-------------|
| TPM_ACCESS  | 0xD40000  | 1    | Access register |
| TPM_STS     | 0xD40018  | 4    | Status register |
| TPM_DATA    | 0xD40024  | 4    | Data FIFO |
| TPM_DID_VID | 0xD40F00  | 4    | Device/Vendor ID |
| TPM_RID     | 0xD40F04  | 1    | Revision ID |

### SPI Command Format

Read command (4 bytes):
```
Byte 0: 0x80 | (length - 1)   ; 0x80 = read, bits 0-5 = transfer size - 1
Byte 1: Address[23:16]        ; High byte (always 0xD4 for TPM)
Byte 2: Address[15:8]         ; Middle byte
Byte 3: Address[7:0]          ; Low byte
```

Write command:
```
Byte 0: 0x00 | (length - 1)   ; 0x00 = write, bits 0-5 = transfer size - 1
Byte 1-3: Address (same as read)
```

### Wait States (Flow Control)

After sending the 4-byte command header, check for wait states:
- If MISO bit 0 = 0: TPM is busy, keep sending dummy bytes
- If MISO bit 0 = 1: TPM is ready, data transfer can begin

### Example: Read TPM_DID_VID

```rust
// Send: [0x83, 0xD4, 0x0F, 0x00] = Read 4 bytes from 0xD40F00
// Wait for bit 0 = 1 in response
// Read 4 bytes: [VID_LO, VID_HI, DID_LO, DID_HI]
```

Expected response for Infineon SLB 9670:
- Vendor ID: 0x15D1 (Infineon)
- Device ID: 0x001B (confirmed working)

## seL4 Microkit Configuration

### System Description (tpmtest.system)

Required memory regions:
```xml
<!-- SPI0 controller -->
<memory_region name="spi0_regs" size="0x1000" phys_addr="0xFE204000" />

<!-- GPIO for SPI pin configuration -->
<memory_region name="gpio_regs" size="0x1000" phys_addr="0xFE200000" />

<!-- UART5 for serial debug -->
<memory_region name="uart_regs" size="0x1000" phys_addr="0xFE201000" />
```

### SPI Configuration (BCM2711)

1. Configure GPIO 7-11 for SPI0 (ALT0 function)
2. Set SPI clock divider (250MHz / divider = SPI clock)
3. Use CS=1 in SPI CS register to select CE1

### Building

```bash
make PLATFORM=rpi4 PRODUCT=tpmtest sdcard
```

## Resources

- [52Pi Wiki - EP-0149](https://wiki.52pi.com/index.php?title=EP-0149)
- [Infineon ELTT2 Tool](https://github.com/infineon/eltt2)
- [Linux tpm_tis_spi driver](https://github.com/torvalds/linux/blob/master/drivers/char/tpm/tpm_tis_spi_main.c)
- [Raspberry Pi tpm-slb9670 overlay](https://github.com/raspberrypi/linux/blob/rpi-6.6.y/arch/arm/boot/dts/overlays/tpm-slb9670-overlay.dts)
- [TCG PC Client Platform TPM Profile (PTP) Specification](https://trustedcomputinggroup.org/resource/pc-client-platform-tpm-profile-ptp-specification/)
- [LetsTrust-TPM Pinout](https://pinout.xyz/pinout/letstrust_tpm)

## Troubleshooting

### TPM returns all zeros (0x00)
- Check chip select: Must use CE1 (GPIO 7), not CE0
- Verify GPIO 7-11 are configured for ALT0

### TPM returns all ones (0xFF)
- Check address format: Must include 0xD4 as high byte
- Verify wait state handling is correct
- Check SPI clock speed (try slower, e.g., 100kHz)

### No HDMI output
- Ensure framebuffer address matches your Pi model (8GB vs 4GB)
- Check config.txt settings

### Serial gibberish
- Try 9600 baud instead of 115200
- Verify GPIO 12/13 are configured for ALT4 (UART5)
